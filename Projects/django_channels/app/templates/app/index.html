<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Simple Plugin WebSocket Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    }

    body {
      background-color: #f5f7ff;
      color: #343a40;
      line-height: 1.6;
      padding: 20px;
    }

    .container {
      max-width: 800px;
      margin: 0 auto;
      background-color: white;
      border-radius: 8px;
      padding: 20px;
      box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    h1 {
      text-align: center;
      margin-bottom: 20px;
      color: #4a6cf7;
    }

    .status {
      display: flex;
      align-items: center;
      margin-bottom: 15px;
      padding: 10px;
      background-color: #f8f9fa;
      border-radius: 5px;
    }

    .status-dot {
      width: 10px;
      height: 10px;
      border-radius: 50%;
      margin-right: 10px;
    }

    .connected {
      background-color: #28a745;
    }

    .disconnected {
      background-color: #dc3545;
    }

    .messages {
      height: 400px;
      overflow-y: auto;
      margin-bottom: 15px;
      padding: 15px;
      border: 1px solid #ddd;
      border-radius: 5px;
      background-color: #fafafa;
    }

    .message {
      padding: 8px 12px;
      margin-bottom: 8px;
      border-radius: 5px;
      max-width: 90%;
    }

    .system {
      background-color: #e9ecef;
      color: #6c757d;
      text-align: center;
      max-width: 100%;
      font-style: italic;
    }

    .sent {
      background-color: #d1ecf1;
      border-left: 3px solid #17a2b8;
      margin-left: auto;
    }

    .received {
      background-color: #d4edda;
      border-left: 3px solid #28a745;
    }

    .reply-request {
      background-color: #fff3cd;
      border-left: 3px solid #ffc107;
      color: #856404;
    }

    .reply {
      background-color: #e2e3f0;
      border-left: 3px solid #6f42c1;
      margin-left: auto;
    }

    .timestamp {
      font-size: 11px;
      color: #6c757d;
      margin-top: 3px;
    }

    .controls {
      display: flex;
      gap: 10px;
      margin-bottom: 15px;
    }

    input[type="text"] {
      flex: 1;
      padding: 10px;
      border: 1px solid #ddd;
      border-radius: 5px;
      font-size: 14px;
    }

    button {
      padding: 10px 15px;
      border: none;
      border-radius: 5px;
      background-color: #4a6cf7;
      color: white;
      cursor: pointer;
      font-size: 14px;
    }

    button:hover:not(:disabled) {
      background-color: #3a5ae0;
    }

    button:disabled {
      background-color: #ccc;
      cursor: not-allowed;
    }

    .plugin-structure {
      background-color: #f8f9fa;
      border: 1px solid #ddd;
      border-radius: 5px;
      padding: 15px;
      margin-top: 15px;
      max-height: 300px;
      overflow-y: auto;
    }

    .plugin-structure h4 {
      margin-bottom: 10px;
      color: #4a6cf7;
    }

    .file-item {
      margin: 5px 0;
      padding: 5px;
      background-color: white;
      border-radius: 3px;
      cursor: pointer;
      border-left: 3px solid #4a6cf7;
    }

    .file-item:hover {
      background-color: #f0f0f0;
    }

    .file-content {
      background-color: #2d3748;
      color: #e2e8f0;
      padding: 10px;
      margin-top: 5px;
      border-radius: 3px;
      font-family: monospace;
      font-size: 12px;
      line-height: 1.4;
      white-space: pre-wrap;
      display: none;
      max-height: 200px;
      overflow-y: auto;
    }
  </style>
</head>
<body>
  <div class="container">
    <h1>Plugin WebSocket Dashboard</h1>
    
    <div class="status">
      <div class="status-dot" id="statusDot"></div>
      <span id="statusText">Disconnected</span>
    </div>

    <div class="messages" id="messages"></div>

    <div class="controls">
      <input type="text" id="messageInput" placeholder="Type a message..." />
      <button id="sendButton" disabled>Send</button>
    </div>

    <div class="plugin-structure" id="pluginStructure">
      <h4>Plugin Structure</h4>
      <p>Waiting for plugin data from MCP server...</p>
    </div>
  </div>

  <script>
    const messagesDiv = document.getElementById('messages');
    const inputEl = document.getElementById('messageInput');
    const sendButton = document.getElementById('sendButton');
    const statusDot = document.getElementById('statusDot');
    const statusText = document.getElementById('statusText');
    const pluginStructure = document.getElementById('pluginStructure');

    let currentPluginStructure = {
        name: 'my-demo-plugin',
        path: 'my-demo-plugin',
        type: 'directory',
        children: [
          {
            name: 'my-demo-plugin.php',
            path: 'my-demo-plugin/my-demo-plugin.php',
            type: 'file',
            content: `<?php
/**
 * Plugin Name: My Demo Plugin
 * Description: A basic demo plugin for learning purposes.
 * Version: 1.0
 * Author: Your Name
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Hook to admin menu
add_action('admin_menu', 'my_demo_plugin_menu');

function my_demo_plugin_menu() {
    add_menu_page(
        'My Demo Plugin',
        'Demo Plugin',
        'manage_options',
        'my-demo-plugin',
        'my_demo_plugin_page',
        'dashicons-smiley',
        20
    );
}

function my_demo_plugin_page() {
    ?>
    <div class="wrap">
        <h1>Welcome to My Demo Plugin</h1>
        <p>This is a simple WordPress plugin example.</p>
        <p>Last updated: <?php echo date('Y-m-d H:i:s'); ?></p>
    </div>
    <?php
}
`
          }
        ]
      };

    // Default plugin structure
    function getDefaultPluginStructure() {
      return {
        name: 'my-demo-plugin',
        path: 'my-demo-plugin',
        type: 'directory',
        children: [
          {
            name: 'my-demo-plugin.php',
            path: 'my-demo-plugin/my-demo-plugin.php',
            type: 'file',
            content: `<?php
/**
 * Plugin Name: My Demo Plugin
 * Description: A basic demo plugin for learning purposes.
 * Version: 1.0
 * Author: Your Name
 */

// Prevent direct access
if (!defined('ABSPATH')) {
    exit;
}

// Hook to admin menu
add_action('admin_menu', 'my_demo_plugin_menu');

function my_demo_plugin_menu() {
    add_menu_page(
        'My Demo Plugin',
        'Demo Plugin',
        'manage_options',
        'my-demo-plugin',
        'my_demo_plugin_page',
        'dashicons-smiley',
        20
    );
}

function my_demo_plugin_page() {
    ?>
    <div class="wrap">
        <h1>Welcome to My Demo Plugin</h1>
        <p>This is a simple WordPress plugin example.</p>
        <p>Last updated: <?php echo date('Y-m-d H:i:s'); ?></p>
    </div>
    <?php
}
`
          }
        ]
      };
    }

    // WebSocket connection
    const wsScheme = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    const socket = new WebSocket(wsScheme + window.location.host + '/ws/ac/');

    socket.onopen = () => {
      statusDot.className = 'status-dot connected';
      statusText.textContent = 'Connected - Ready for MCP requests';
      sendButton.disabled = false;
      
      // Initialize with default plugin structure
      currentPluginStructure = getDefaultPluginStructure();
      displayPluginStructure(currentPluginStructure);
      
      appendMessage('ðŸŸ¢ Connected to server', 'system');
    };

    socket.onmessage = (e) => {
      try {
        const data = JSON.parse(e.data);

        if (data.type === 'greeting') {
          appendMessage(`Server: ${data.message}`, 'system');
          return;
        }

        // Handle folder read request from MCP server
        if (data.command === 'read_folder_request' || data.type === 'folder_request') {
          const messageId = data.message_id;
          const path = data.path || '';
          
          appendMessage(`ðŸ” MCP requesting folder: ${path || 'root'}`, 'reply-request');

          // Send current plugin structure
          const response = {
            command: 'folder_response',
            type: 'folder_response',
            message_id: messageId,
            path: path,
            folder_structure: currentPluginStructure
          };
          
          setTimeout(() => {
            socket.send(JSON.stringify(response));
            appendMessage(`âœ… Sent folder structure`, 'reply');
          }, 100);
          return;
        }

        // Handle folder update from MCP server
        if (data.command === 'update_folder_request' || data.type === 'folder_update') {
          const messageId = data.message_id;
          const path = data.path || '';
          const folderStructure = data.folder_structure;
          
          appendMessage(`ðŸ“ MCP updating folder: ${path || 'root'}`, 'reply-request');

          // Update plugin structure
          console.log('Updating plugin structure:', folderStructure);
          currentPluginStructure = folderStructure;
          console.log('Current plugin structure:', currentPluginStructure);
          displayPluginStructure(currentPluginStructure);

          // Send confirmation
          const response = {
            command: 'folder_updated',
            type: 'folder_updated',
            message_id: messageId,
            status: 'success',
            message: 'Folder updated successfully'
          };
          setTimeout(() => {
            socket.send(JSON.stringify(response));
            appendMessage(`âœ… Folder updated successfully`, 'reply');
          }, 100);
          return;
        }

        // Handle regular messages
        if (data.message) {
          appendMessage(`Received: ${data.message}`, 'received');
        } else {
          appendMessage(`Received: ${JSON.stringify(data)}`, 'received');
        }

      } catch (err) {
        appendMessage(`Raw: ${e.data}`, 'received');
      }
    };

    socket.onclose = () => {
      statusDot.className = 'status-dot disconnected';
      statusText.textContent = 'Disconnected';
      sendButton.disabled = true;
      appendMessage('ðŸ”´ Disconnected from server', 'system');
    };

    socket.onerror = (err) => {
      appendMessage('âŒ WebSocket error', 'system');
    };

    // Send button
    sendButton.onclick = () => {
      const msg = inputEl.value.trim();
      if (!msg) return;
      
      const payload = {
        message: msg,
        timestamp: Date.now()
      };
      
      socket.send(JSON.stringify(payload));
      appendMessage(`Sent: ${msg}`, 'sent');
      inputEl.value = '';
    };

    // Enter key to send
    inputEl.addEventListener('keypress', (e) => {
      if (e.key === 'Enter' && !sendButton.disabled) {
        sendButton.click();
      }
    });

    // Display plugin structure
    function displayPluginStructure(structure) {
      if (!structure) return;
      
      let html = `<h4>Plugin: ${structure.name}</h4>`;
      
      if (structure.children) {
        structure.children.forEach(child => {
          if (child.type === 'file') {
            html += `
              <div class="file-item" onclick="toggleFileContent('${child.name}')">
                ðŸ“„ ${child.name}
              </div>
              <div class="file-content" id="content-${child.name}">${child.content || ''}</div>
            `;
          }
        });
      }
      
      pluginStructure.innerHTML = html;
    }

    // Toggle file content visibility
    function toggleFileContent(fileName) {
      const content = document.getElementById(`content-${fileName}`);
      if (content) {
        content.style.display = content.style.display === 'none' ? 'block' : 'none';
      }
    }

    // Add message to chat
    function appendMessage(text, type) {
      const div = document.createElement('div');
      div.className = `message ${type}`;
      
      const content = document.createElement('div');
      content.textContent = text;
      div.appendChild(content);
      
      const timestamp = document.createElement('div');
      timestamp.className = 'timestamp';
      timestamp.textContent = new Date().toLocaleTimeString();
      div.appendChild(timestamp);
      
      messagesDiv.appendChild(div);
      messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }

    // Initialize
    statusDot.className = 'status-dot disconnected';
    currentPluginStructure = getDefaultPluginStructure();
    displayPluginStructure(currentPluginStructure);
  </script>
</body>
</html>